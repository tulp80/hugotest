{{ define "head" }}
  {{- $hero := .Params.hero -}}
  {{- with $hero.image -}}
    {{- $raw := . -}}
    {{- $path := strings.TrimPrefix "/" $raw -}}
    {{- $image := resources.GetMatch (printf "images/%s" $path) -}}
    {{- if not $image -}}
      {{- $image = resources.GetMatch (printf "images/%s" (path.Base $path)) -}}
    {{- end -}}
    {{- if $image -}}
      {{- $sizes := "(min-width: 960px) 40vw, 88vw" -}}
      {{- $candidates := slice 640 960 1280 -}}
      {{- $widths := slice -}}
      {{- range $candidates -}}
        {{- if le . $image.Width -}}
          {{- $widths = $widths | append . -}}
        {{- end -}}
      {{- end -}}
      {{- if not (gt (len $widths) 0) -}}
        {{- $fallbackWidth := cond (gt $image.Width 1280) 1280 $image.Width -}}
        {{- $widths = slice $fallbackWidth -}}
      {{- end -}}
      {{- $largestWidth := index $widths (sub (len $widths) 1) -}}
      {{- $largest := $image.Resize (printf "%dx jpg" $largestWidth) -}}
      {{- $srcset := slice -}}
      {{- range $widths -}}
        {{- $variant := cond (eq . $largestWidth) $largest ($image.Resize (printf "%dx jpg" .)) -}}
        {{- $srcset = $srcset | append (printf "%s %dw" $variant.RelPermalink .) -}}
      {{- end -}}
      <link rel="preload" as="image" href="{{ $largest.RelPermalink }}" imagesrcset="{{ delimit $srcset ", " }}" imagesizes="{{ $sizes }}" fetchpriority="high">
    {{- end -}}
  {{- end -}}
{{ end }}

{{ define "main" }}
  {{ $hero := .Params.hero }}
  <section class="hero">
    <div class="hero__bg" aria-hidden="true"></div>
    <div class="container hero__layout">
      <div class="hero__content">
        <h1 class="hero__title">{{ $hero.title | default .Title }}</h1>
        {{ with $hero.description }}<p class="hero__text">{{ . }}</p>{{ end }}
        <div class="badge-list">
          {{ range $hero.highlights }}
            <span class="badge-list__item"><span class="badge-list__icon">✓</span>{{ . }}</span>
          {{ end }}
        </div>
        {{ with $hero.button }}
          <div>
            <a class="btn btn--accent" href="{{ .url }}">{{ .text }}</a>
          </div>
        {{ end }}
      </div>
      {{ with $hero.image }}
        <div class="hero__media">
          {{ partial "responsive-image.html" (dict "src" . "alt" ($hero.image_alt | default "Ayaselva") "loading" "eager" "fetchpriority" "high" "sizes" "(min-width: 960px) 40vw, 88vw" "widths" (slice 640 960 1280 1600)) }}
        </div>
      {{ end }}
    </div>
  </section>

  {{ range .Params.sections }}
    {{ $section := . }}
    <section class="section">
      <div class="container">
        <div class="split{{ if $section.reverse }} split--reverse{{ end }}">
          <div class="split__text">
            <h2>{{ $section.title }}</h2>
            {{ range $section.paragraphs }}<p>{{ . }}</p>{{ end }}
          </div>
          {{ with $section.image }}
            <div class="split__media">
              {{ partial "responsive-image.html" (dict "src" . "alt" ($section.image_alt | default "Ayaselva") "sizes" "(min-width: 960px) 45vw, 92vw" "widths" (slice 640 960 1280)) }}
            </div>
          {{ end }}
        </div>
      </div>
    </section>
  {{ end }}

  {{ $blog := .Params.blog }}
  {{ $posts := first 3 (sort (where .Site.RegularPages "Section" "blog") "Date" "desc") }}
  {{ if gt (len $posts) 0 }}
    <section class="section section--accent">
      <div class="container">
        <h2 class="section__title">{{ $blog.title | default "Blog" }}</h2>
        {{ with $blog.subtitle }}<p class="section__subtitle">{{ . }}</p>{{ end }}
        <div class="blog-grid">
          {{ range $posts }}
            {{ $post := . }}
            <article class="blog-card">
              {{ with $post.Params.image }}
                <div class="blog-card__media">{{ partial "responsive-image.html" (dict "src" . "alt" $post.Title "sizes" "(min-width: 960px) 320px, 80vw" "widths" (slice 320 480 640)) }}</div>
              {{ end }}
              <div class="blog-card__body">
                <div class="blog-card__meta">{{ $post.Date.Format "02 Jan 2006" }}</div>
                <h3 class="blog-card__title"><a href="{{ $post.RelPermalink }}">{{ $post.Title }}</a></h3>
                {{ with $post.Params.excerpt }}<p class="blog-card__excerpt">{{ . }}</p>{{ end }}
                <a class="blog-card__link" href="{{ $post.RelPermalink }}">Read more →</a>
              </div>
            </article>
          {{ end }}
        </div>
        <div style="text-align:center; margin-top:2rem;">
          <a class="btn btn--primary" href="{{ relLangURL "/blog/" }}">View all posts</a>
        </div>
      </div>
    </section>
  {{ end }}
{{ end }}
