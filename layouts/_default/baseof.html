<!DOCTYPE html>
<html lang="{{ with .Site.LanguageCode }}{{ . }}{{ else }}en{{ end }}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {{- $siteParams := .Site.Params -}}
    {{- $siteName := default .Site.Title $siteParams.siteName -}}
    {{- $pageMeta := or .Params.metadata (dict) -}}
    {{- $rawTitle := default (index $pageMeta "title") .Title -}}
    {{- if not $rawTitle -}}{{- $rawTitle = $siteName -}}{{- end -}}
    <title>{{ $rawTitle }}</title>
    {{- $description := "" -}}
    {{- with index $pageMeta "description" -}}
      {{- $description = . -}}
    {{- end -}}
    {{- if and (eq $description "") .Params.description -}}
      {{- $description = .Params.description -}}
    {{- end -}}
    {{- if and (eq $description "") .Summary -}}
      {{- $description = (.Summary | plainify | truncate 160) -}}
    {{- end -}}
    {{- if and (eq $description "") $siteParams.description -}}
      {{- $description = $siteParams.description -}}
    {{- end -}}
    {{- if $description }}<meta name="description" content="{{ $description }}">{{ end -}}

    {{- $canonical := or (index $pageMeta "canonical") .RelPermalink -}}
    {{- if $canonical -}}
      {{- if not (hasPrefix $canonical "http") -}}{{- $canonical = absURL $canonical -}}{{- end -}}
      <link rel="canonical" href="{{ $canonical }}">
    {{- end -}}

    {{- $robotsIndex := true -}}
    {{- $robotsFollow := true -}}
    {{- with $siteParams.robots -}}
      {{- with index . "index" -}}{{- $robotsIndex = . -}}{{- end -}}
      {{- with index . "follow" -}}{{- $robotsFollow = . -}}{{- end -}}
    {{- end -}}
    {{- with index $pageMeta "robots" -}}
      {{- with index . "index" -}}{{- $robotsIndex = . -}}{{- end -}}
      {{- with index . "follow" -}}{{- $robotsFollow = . -}}{{- end -}}
    {{- end -}}
    <meta name="robots" content="{{ if $robotsIndex }}index{{ else }}noindex{{ end }},{{ if $robotsFollow }}follow{{ else }}nofollow{{ end }}">

    {{- $ogType := "website" -}}
    {{- with index $pageMeta "openGraph" -}}
      {{- with index . "type" -}}{{- if . -}}{{- $ogType = . -}}{{- end -}}{{- end -}}
    {{- end -}}
    {{- if and (or (eq $ogType "") (eq $ogType "website")) $siteParams.opengraph -}}
      {{- with index $siteParams.opengraph "type" -}}{{- if . -}}{{- $ogType = . -}}{{- end -}}{{- end -}}
    {{- end -}}
    {{- if and (eq $ogType "website") (eq .Section "blog") -}}
      {{- $ogType = "article" -}}
    {{- end -}}
    {{- if eq $ogType "" -}}{{- $ogType = "website" -}}{{- end -}}

    {{- $ogImage := "" -}}
    {{- with index $pageMeta "image" -}}{{- $ogImage = . -}}{{- end -}}
    {{- if and (eq $ogImage "") .Params.image -}}{{- $ogImage = .Params.image -}}{{- end -}}
    {{- if eq $ogImage "" -}}
      {{- with .Params.hero -}}
        {{- with .image -}}{{- $ogImage = . -}}{{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if eq $ogImage "" -}}
      {{- with $siteParams.opengraph -}}
        {{- with index . "defaultImage" -}}{{- if . -}}{{- $ogImage = . -}}{{- end -}}{{- end -}}
      {{- end -}}
    {{- end -}}
    {{- if and $ogImage (not (hasPrefix $ogImage "http")) -}}{{- $ogImage = absURL $ogImage -}}{{- end -}}

    <meta property="og:site_name" content="{{ $siteName }}">
    <meta property="og:title" content="{{ $rawTitle }}">
    {{- if $description }}<meta property="og:description" content="{{ $description }}">{{ end -}}
    {{- if $canonical }}<meta property="og:url" content="{{ $canonical }}">{{ end -}}
    <meta property="og:type" content="{{ $ogType }}">
    {{- if $ogImage }}<meta property="og:image" content="{{ $ogImage }}">{{ end -}}

    {{- $twitterHandle := $siteParams.twitterHandle -}}
    <meta name="twitter:card" content="{{ if $ogImage }}summary_large_image{{ else }}summary{{ end }}">
    {{- if $twitterHandle }}<meta name="twitter:site" content="{{ $twitterHandle }}">{{ end -}}
    <meta name="twitter:title" content="{{ $rawTitle }}">
    {{- if $description }}<meta name="twitter:description" content="{{ $description }}">{{ end -}}
    {{- if $ogImage }}<meta name="twitter:image" content="{{ $ogImage }}">{{ end -}}

    {{- with $siteParams.googleSiteVerificationId -}}<meta name="google-site-verification" content="{{ . }}">{{ end -}}
    <meta http-equiv="x-dns-prefetch-control" content="on">
    <link rel="preconnect" href="https://esm.sh" crossorigin>
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

    {{- $critical := resources.Get "css/critical.css" | resources.Minify -}}
    {{- $fontsCSS := resources.Get "css/fonts.css" -}}
    {{- $mainCSS := resources.Get "css/main.css" -}}
    {{- $appCSS := slice $fontsCSS $mainCSS | resources.Concat "css/app.css" | resources.Minify -}}
    {{- $appAsset := $appCSS | resources.Fingerprint "sha384" -}}

    <link rel="preload" href="{{ "/fonts/InterVariableLatin.woff2" | relURL }}" as="font" type="font/woff2" crossorigin>
    {{- if $critical }}<style data-critical>{{ $critical.Content | safeCSS }}</style>{{ end -}}
    <link rel="preload" href="{{ $appAsset.RelPermalink }}" as="style" integrity="{{ $appAsset.Data.Integrity }}" crossorigin>
    <link rel="stylesheet" href="{{ $appAsset.RelPermalink }}" integrity="{{ $appAsset.Data.Integrity }}" media="print" onload="this.media='all'">
    <noscript><link rel="stylesheet" href="{{ $appAsset.RelPermalink }}" integrity="{{ $appAsset.Data.Integrity }}" crossorigin></noscript>
    {{ block "head" . }}{{ end }}
  </head>
  <body>
    {{ partial "header.html" . }}
    <main id="app-shell" role="main" data-view-transition-name="page">
      {{ block "main" . }}{{ end }}
    </main>
    {{ partial "footer.html" . }}
    <script type="module">
      import * as Turbo from 'https://esm.sh/@hotwired/turbo@8.0.4?bundle';
      Turbo.session.drive = true;

      const initNavDrawer = () => {
        const toggle = document.querySelector('[data-nav-toggle]');
        const drawer = document.querySelector('[data-nav-drawer]');
        if (!toggle || !drawer) return;

        const updateState = () => {
          const isOpen = drawer.classList.contains('is-open');
          document.body.classList.toggle('no-scroll', isOpen);
          toggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        };

        toggle.onclick = () => {
          drawer.classList.toggle('is-open');
          updateState();
        };

        drawer.onclick = (event) => {
          if (event.target === drawer) {
            drawer.classList.remove('is-open');
            updateState();
          }
        };

        drawer.querySelectorAll('[data-nav-close]').forEach((link) => {
          link.onclick = () => {
            drawer.classList.remove('is-open');
            updateState();
          };
        });

        updateState();
      };

      const initEnhancements = () => {
        initNavDrawer();
      };

      let quicklinkActive = false;
      const initPrefetch = async () => {
        if (quicklinkActive) return;
        const { listen } = await import('https://esm.sh/quicklink@2.3.0?bundle');
        listen({
          origins: [location.origin],
          ignores: [/\.pdf$/i, /\/(wp-)?admin/],
          timeoutFn: window.requestIdleCallback || ((fn) => setTimeout(fn, 1))
        });
        quicklinkActive = true;
      };

      const hovered = new Set();
      const hoverPrefetch = (event) => {
        const anchor = event.target.closest('a[href]');
        if (!anchor) return;
        if (anchor.target === '_blank' || anchor.hasAttribute('download') || anchor.getAttribute('rel')?.includes('external')) return;
        if (anchor.origin !== location.origin) return;
        const url = anchor.href.split('#')[0];
        if (hovered.has(url)) return;
        hovered.add(url);
        const link = document.createElement('link');
        link.rel = 'prefetch';
        link.href = url;
        link.as = 'document';
        document.head.appendChild(link);
      };

      const setupViewTransitions = () => {
        if (!document.startViewTransition) return;
        document.addEventListener('turbo:before-render', (event) => {
          event.preventDefault();
          const { resume } = event.detail;
          document.startViewTransition(() => {
            resume();
            initEnhancements();
          });
        });
      };

      const registerServiceWorker = () => {
        if (!('serviceWorker' in navigator)) return;
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('{{ "sw.js" | relURL }}', { scope: '{{ "/" | relURL }}' }).catch((error) => {
            console.error('SW registration failed', error);
          });
        });
      };

      document.addEventListener('DOMContentLoaded', () => {
        initEnhancements();
        initPrefetch().catch(console.error);
        document.addEventListener('pointerenter', hoverPrefetch, { passive: true, capture: true });
      });

      document.addEventListener('turbo:load', () => {
        initEnhancements();
      });

      document.addEventListener('turbo:before-visit', () => {
        const drawer = document.querySelector('[data-nav-drawer]');
        if (drawer) {
          drawer.classList.remove('is-open');
          document.body.classList.remove('no-scroll');
        }
      });

      setupViewTransitions();
      registerServiceWorker();
    </script>
    {{ block "scripts" . }}{{ end }}
  </body>
</html>
